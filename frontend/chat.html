<!DOCTYPE html>

<html class="light" lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>shifa.ai Chat</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap"
        rel="stylesheet" />
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
        rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#2bee9d",
                        "background-light": "#f6f8f7",
                        "background-dark": "#10221a",
                        "surface-light": "#ffffff",
                        "surface-dark": "#1a2c24",
                    },
                    fontFamily: {
                        "display": ["Inter", "sans-serif"]
                    },
                    borderRadius: { "DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "2xl": "1rem", "full": "9999px" },
                },
            },
        }
    </script>
    <style>
        /* Custom scrollbar for webkit browsers */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background-color: rgba(0, 0, 0, 0.1);
            border-radius: 20px;
        }

        .dark ::-webkit-scrollbar-thumb {
            background-color: rgba(255, 255, 255, 0.1);
        }
    </style>
    <style>
        body {
            min-height: max(884px, 100dvh);
        }
    </style>
</head>

<body
    class="bg-background-light dark:bg-background-dark font-display h-screen flex flex-col overflow-hidden text-[#111815] dark:text-gray-100">
    <!-- Sticky Header -->
    <header
        class="flex-none bg-surface-light dark:bg-surface-dark px-4 py-3 shadow-sm z-20 border-b border-gray-100 dark:border-gray-800">
        <div class="flex items-center justify-between max-w-3xl mx-auto w-full">
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 rounded-full bg-primary/20 flex items-center justify-center text-primary">
                    <span class="material-symbols-outlined text-xl">medical_services</span>
                </div>
                <h2 class="text-lg font-bold leading-tight tracking-tight">shifa.ai</h2>
            </div>
            <div class="flex items-center">
                <div
                    class="bg-background-light dark:bg-background-dark border border-gray-200 dark:border-gray-700 rounded-full px-3 py-1 flex items-center gap-1.5">
                    <span class="material-symbols-outlined text-[16px] text-[#618979] dark:text-primary">bolt</span>
                    <p id="quota-display"
                        class="text-[#618979] dark:text-gray-300 text-xs font-bold tracking-wide uppercase">10 / 10 free
                    </p>
                </div>
            </div>
        </div>
    </header>
    <!-- Chat Area -->
    <main
        class="flex-1 overflow-y-auto p-4 space-y-6 scroll-smooth bg-background-light dark:bg-background-dark w-full mx-auto max-w-3xl pb-6">
        <!-- Date Separator -->
        <div class="flex justify-center pt-2">
            <span
                class="text-xs font-medium text-gray-400 dark:text-gray-500 bg-gray-100 dark:bg-gray-800 px-3 py-1 rounded-full">Today</span>
        </div>
        <!-- AI Welcome Message (Kept as initial state) -->
        <div id="welcome-message" class="flex items-end gap-3 group">
            <div aria-hidden="true"
                class="bg-white dark:bg-surface-dark border border-gray-100 dark:border-gray-700 shadow-sm aspect-square rounded-full w-8 h-8 shrink-0 flex items-center justify-center overflow-hidden">
                <img class="w-full h-full object-cover" data-alt="AI Medical Assistant Avatar Icon"
                    src="https://lh3.googleusercontent.com/aida-public/AB6AXuDPRYsXLkPl9u8qJBtx1SWbSIAcGTXyb9V1ndTWUbVUXRl-BjS7c7wdfBYuIYKQkHcybKe7xLx32lvQ9XkCXf9rAXtU_1OwwJ6_jAst3gz-Vl9j2AYMZQk5MFSP30Xid89LR3_bPL4xPqPd_6CE-5CCTayO4wQhZt-ECs-PId39HWLMSy51MVpFcE9gAq7fjRqtdYIoL_h3s6zg7sksMwzGObknmwl_lVEBM4onJ8Vxv0Kkb9E9w-FaOb3ZP8sJSpgvEzA1MfW_mTc" />
            </div>
            <div class="flex flex-1 flex-col gap-1 items-start max-w-[85%] sm:max-w-[70%]">
                <div class="flex items-center justify-between w-full px-1">
                    <p class="text-[#618979] dark:text-primary text-xs font-medium">Shifa AI</p>
                    <p class="text-gray-400 text-[10px]">Just now</p>
                </div>
                <div
                    class="text-[15px] font-normal leading-relaxed rounded-2xl rounded-tl-none px-4 py-3 bg-surface-light dark:bg-surface-dark text-[#111815] dark:text-gray-100 shadow-sm border border-gray-100 dark:border-gray-800">
                    Hello! I am Shifa, your AI health assistant. How can I help you understand your symptoms today?
                </div>
            </div>
        </div>
        <!-- Typing Indicator -->
        <div class="flex items-end gap-3 group opacity-75">
            <div aria-hidden="true"
                class="bg-white dark:bg-surface-dark border border-gray-100 dark:border-gray-700 shadow-sm aspect-square rounded-full w-8 h-8 shrink-0 flex items-center justify-center overflow-hidden">
                <img class="w-full h-full object-cover" data-alt="AI Medical Assistant Avatar Icon"
                    src="https://lh3.googleusercontent.com/aida-public/AB6AXuDHbmBUrgXqBhYLV-zops_f8sUwm-0bEI5ktvti9-yjnbalVA1-LxHmM1VC2spvq2SVkdWlxvDG4sVWITcqpOcN8LjfCCS9z_53mpXfJYHUs3uJ4KlA4VJkFTxg6JbgXHc-eLOFBPRb4V3EQrlqqLzlC3pnct75MhHh0EYHnoeT0lZHrch4uTYUDa2ghJ6uYIpFIMoI1XRkx1wSsN3TTrO3ylX6nVRpvwXe62Dye-AAVJCZmtOmtUzXw-PsO11nCqaaqctDtk3J7-0" />
            </div>
            <div
                class="rounded-2xl rounded-tl-none px-4 py-3 bg-surface-light dark:bg-surface-dark shadow-sm border border-gray-100 dark:border-gray-800 flex items-center gap-1 h-[46px]">
                <div class="w-1.5 h-1.5 bg-gray-400 rounded-full"></div>
                <div class="w-1.5 h-1.5 bg-gray-400 rounded-full opacity-70"></div>
                <div class="w-1.5 h-1.5 bg-gray-400 rounded-full opacity-40"></div>
            </div>
        </div>
    </main>
    <!-- Bottom Input Area -->
    <footer
        class="flex-none bg-surface-light dark:bg-surface-dark border-t border-gray-100 dark:border-gray-800 z-20 pb-safe">
        <div class="max-w-3xl mx-auto w-full flex flex-col">
            <!-- Upload Helper Text -->
            <div
                class="w-full py-2 bg-background-light dark:bg-background-dark border-b border-gray-100 dark:border-gray-800 flex items-center justify-center">
                <span class="material-symbols-outlined text-[14px] text-primary mr-1">info</span>
                <p class="text-gray-500 dark:text-gray-400 text-xs text-center font-medium">Upload medical reports only
                    (PNG, JPG, PDF)</p>
            </div>
            <!-- Input Bar -->
            <div class="p-3 flex items-end gap-2">
                <!-- Attachment Button -->
                <button aria-label="Upload file"
                    class="flex-none h-12 w-12 rounded-full flex items-center justify-center text-gray-500 hover:text-primary hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors focus:outline-none focus:ring-2 focus:ring-primary/50">
                    <span class="material-symbols-outlined text-2xl rotate-45">attach_file</span>
                </button>
                <!-- Text Input -->
                <div
                    class="flex-1 bg-gray-100 dark:bg-[#25362e] rounded-3xl flex items-center min-h-[48px] px-4 py-2 border border-transparent focus-within:border-primary focus-within:ring-1 focus-within:ring-primary/20 transition-all">
                    <input id="message-input"
                        class="bg-transparent border-none w-full text-[15px] placeholder-gray-500 text-gray-900 dark:text-white focus:ring-0 p-0 m-0"
                        placeholder="Type a message..." type="text" />
                </div>
                <!-- Send Button -->
                <button id="send-button" aria-label="Send message"
                    class="flex-none h-12 w-12 rounded-full bg-primary flex items-center justify-center text-[#10221a] shadow-md hover:shadow-lg hover:bg-[#25d68d] transition-all focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary dark:focus:ring-offset-background-dark">
                    <span class="material-symbols-outlined text-2xl translate-x-0.5">send</span>
                </button>
            </div>
        </div>
    </footer>
    <script src="/assets/js/api.js"></script>
    <script>
        const chatContainer = document.querySelector('main');
        const messageInput = document.getElementById('message-input');
        const sendBtn = document.getElementById('send-button');
        const quotaDisplay = document.getElementById('quota-display');

        console.log('DOM elements:', { chatContainer, messageInput, sendBtn, quotaDisplay });

        const userId = localStorage.getItem('shifa_user_id');
        console.log('User ID:', userId);

        if (!userId) {
            console.error('No user ID found, redirecting...');
            window.location.href = '/get-started';
        }

        function createMessageElement(role, content, time) {
            const isAI = role === 'assistant';
            const div = document.createElement('div');
            div.className = isAI ? 'flex items-end gap-3 group' : 'flex items-end gap-3 justify-end group';

            const avatarHtml = isAI
                ? `<div aria-hidden="true" class="bg-white dark:bg-surface-dark border border-gray-100 dark:border-gray-700 shadow-sm aspect-square rounded-full w-8 h-8 shrink-0 flex items-center justify-center overflow-hidden">
                    <img class="w-full h-full object-cover" src="https://lh3.googleusercontent.com/aida-public/AB6AXuDPRYsXLkPl9u8qJBtx1SWbSIAcGTXyb9V1ndTWUbVUXRl-BjS7c7wdfBYuIYKQkHcybKe7xLx32lvQ9XkCXf9rAXtU_1OwwJ6_jAst3gz-Vl9j2AYMZQk5MFSP30Xid89LR3_bPL4xPqPd_6CE-5CCTayO4wQhZt-ECs-PId39HWLMSy51MVpFcE9gAq7fjRqtdYIoL_h3s6zg7sksMwzGObknmwl_lVEBM4onJ8Vxv0Kkb9E9w-FaOb3ZP8sJSpgvEzA1MfW_mTc" />
                   </div>`
                : `<div aria-hidden="true" class="bg-gray-200 dark:bg-gray-700 aspect-square rounded-full w-8 h-8 shrink-0 flex items-center justify-center overflow-hidden">
                    <span class="material-symbols-outlined text-gray-500 dark:text-gray-300 text-lg">person</span>
                   </div>`;

            const messageHtml = `
                <div class="flex flex-1 flex-col gap-1 ${isAI ? 'items-start' : 'items-end'} max-w-[85%] sm:max-w-[70%]">
                    <div class="flex items-center justify-between w-full px-1 ${!isAI ? 'flex-row-reverse' : ''}">
                        <p class="${isAI ? 'text-[#618979] dark:text-primary' : 'text-gray-500 dark:text-gray-400'} text-xs font-medium">${isAI ? 'Shifa AI' : 'You'}</p>
                        <p class="text-gray-400 text-[10px]">${time}</p>
                    </div>
                    <div class="${isAI ? 'bg-surface-light dark:bg-surface-dark text-[#111815] dark:text-gray-100 border border-gray-100 dark:border-gray-800' : 'bg-primary text-[#10221a]'} text-[15px] font-normal leading-relaxed rounded-2xl ${isAI ? 'rounded-tl-none' : 'rounded-tr-none'} px-4 py-3 shadow-sm">
                        ${content}
                    </div>
                </div>
            `;

            div.innerHTML = isAI ? avatarHtml + messageHtml : messageHtml + avatarHtml;
            return div;
        }

        function scrollToBottom() {
            if (chatContainer) {
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
        }

        async function loadHistory() {
            if (!userId) return;

            try {
                const history = await apiRequest(`/chat/history/${userId}`);

                if (history && history.length > 0) {
                    // Clear EVERYTHING first
                    chatContainer.innerHTML = `
                        <div class="flex justify-center pt-2">
                            <span class="text-xs font-medium text-gray-400 dark:text-gray-500 bg-gray-100 dark:bg-gray-800 px-3 py-1 rounded-full">Today</span>
                        </div>
                    `;

                    history.forEach(msg => {
                        const time = new Date(msg.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                        chatContainer.appendChild(createMessageElement(msg.role, msg.content, time));
                    });
                    scrollToBottom();
                }
            } catch (error) {
                console.error('Failed to load history:', error);
            }
        }

        async function sendMessage() {
            if (!messageInput || !sendBtn) {
                console.error('Input elements not found!');
                return;
            }

            const text = messageInput.value.trim();
            if (!text) {
                console.log('Empty message, not sending');
                return;
            }

            console.log('Sending message:', text);
            messageInput.value = '';
            sendBtn.disabled = true;

            const now = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            chatContainer.appendChild(createMessageElement('user', text, now));
            scrollToBottom();

            // Add typing indicator
            const typingDiv = document.createElement('div');
            typingDiv.className = 'flex items-end gap-3 group opacity-75 typing-indicator';
            typingDiv.innerHTML = `
            <div aria-hidden="true" class="bg-white dark:bg-surface-dark border border-gray-100 dark:border-gray-700 shadow-sm aspect-square rounded-full w-8 h-8 shrink-0 flex items-center justify-center overflow-hidden">
                <img class="w-full h-full object-cover" src="https://lh3.googleusercontent.com/aida-public/AB6AXuDPRYsXLkPl9u8qJBtx1SWbSIAcGTXyb9V1ndTWUbVUXRl-BjS7c7wdfBYuIYKQkHcybKe7xLx32lvQ9XkCXf9rAXtU_1OwwJ6_jAst3gz-Vl9j2AYMZQk5MFSP30Xid89LR3_bPL4xPqPd_6CE-5CCTayO4wQhZt-ECs-PId39HWLMSy51MVpFcE9gAq7fjRqtdYIoL_h3s6zg7sksMwzGObknmwl_lVEBM4onJ8Vxv0Kkb9E9w-FaOb3ZP8sJSpgvEzA1MfW_mTc" />
            </div>
            <div class="rounded-2xl rounded-tl-none px-4 py-3 bg-surface-light dark:bg-surface-dark shadow-sm border border-gray-100 dark:border-gray-800 flex items-center gap-1 h-[46px]">
                <div class="w-1.5 h-1.5 bg-gray-400 rounded-full animate-bounce"></div>
                <div class="w-1.5 h-1.5 bg-gray-400 rounded-full animate-bounce [animation-delay:0.2s]"></div>
                <div class="w-1.5 h-1.5 bg-gray-400 rounded-full animate-bounce [animation-delay:0.4s]"></div>
            </div>
        `;
            chatContainer.appendChild(typingDiv);
            scrollToBottom();

            try {
                const response = await apiRequest('/chat/send', {
                    method: 'POST',
                    body: { user_id: parseInt(userId), message: text }
                });

                console.log('AI response received:', response);

                const typingIndicator = chatContainer.querySelector('.typing-indicator');
                if (typingIndicator) {
                    chatContainer.removeChild(typingIndicator);
                }

                const aiTime = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                chatContainer.appendChild(createMessageElement('assistant', response.reply, aiTime));

                if (quotaDisplay) {
                    quotaDisplay.textContent = `${response.questions_left} / 10 free`;
                }

                scrollToBottom();
            } catch (error) {
                console.error('Send message error:', error);

                const typingIndicator = chatContainer.querySelector('.typing-indicator');
                if (typingIndicator) {
                    chatContainer.removeChild(typingIndicator);
                }

                alert('Error: ' + error.message);
            } finally {
                sendBtn.disabled = false;
                messageInput.focus();
            }
        }

        // Event listeners
        if (sendBtn) {
            sendBtn.addEventListener('click', sendMessage);
            console.log('Send button listener attached');
        }

        if (messageInput) {
            messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            console.log('Input keypress listener attached');

            // Focus input on page load
            messageInput.focus();
        }

        // Load history when page loads
        if (userId) {
            console.log('Initializing chat...');
            loadHistory();
        }
    </script>
</body>

</html>